name: CI/CD Pipeline - Gabi Family Docs

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  EXPO_VERSION: 'latest'

jobs:
  # Job de Qualidade de CÃ³digo
  code-quality:
    name: ğŸ” Qualidade de CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'gabi-family-docs-app/package-lock.json'
        
    - name: ğŸ“¦ Instalar dependÃªncias
      working-directory: ./gabi-family-docs-app
      run: npm ci
      
    - name: ğŸ”§ Verificar tipos TypeScript
      working-directory: ./gabi-family-docs-app
      run: npm run type-check
      
    - name: ğŸ“ Executar ESLint
      working-directory: ./gabi-family-docs-app
      run: npm run lint
      
    - name: ğŸ¨ Verificar formataÃ§Ã£o Prettier
      working-directory: ./gabi-family-docs-app
      run: npm run format:check
      
    - name: ğŸ”’ Verificar vulnerabilidades de seguranÃ§a
      working-directory: ./gabi-family-docs-app
      run: npm audit --audit-level=moderate
      
    - name: ğŸ“Š Gerar relatÃ³rio de cobertura
      working-directory: ./gabi-family-docs-app
      run: npm run test:coverage
      
    - name: ğŸ“ˆ Upload relatÃ³rio de cobertura
      uses: codecov/codecov-action@v3
      with:
        file: ./gabi-family-docs-app/coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Job de Testes
  tests:
    name: ğŸ§ª Testes
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        node-version: [16, 18, 20]
        
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: 'gabi-family-docs-app/package-lock.json'
        
    - name: ğŸ“¦ Instalar dependÃªncias
      working-directory: ./gabi-family-docs-app
      run: npm ci
      
    - name: ğŸ§ª Executar testes unitÃ¡rios
      working-directory: ./gabi-family-docs-app
      run: npm run test
      
    - name: ğŸ§ª Executar testes E2E (Android)
      working-directory: ./gabi-family-docs-app
      run: |
        npm run build:android
        npm run test:e2e:android
      continue-on-error: true
      
    - name: ğŸ§ª Executar testes E2E (iOS)
      working-directory: ./gabi-family-docs-app
      run: |
        npm run build:ios
        npm run test:e2e:ios
      continue-on-error: true

  # Job de Build
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [code-quality, tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'gabi-family-docs-app/package-lock.json'
        
    - name: ğŸ“¦ Instalar dependÃªncias
      working-directory: ./gabi-family-docs-app
      run: npm ci
      
    - name: ğŸ”§ Setup Expo
      working-directory: ./gabi-family-docs-app
      run: |
        npm install -g @expo/cli@${{ env.EXPO_VERSION }}
        expo doctor
      
    - name: ğŸ—ï¸ Build Android APK
      working-directory: ./gabi-family-docs-app
      run: |
        expo build:android --type apk --non-interactive
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        
    - name: ğŸ—ï¸ Build iOS IPA
      working-directory: ./gabi-family-docs-app
      run: |
        expo build:ios --type archive --non-interactive
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        
    - name: ğŸ“¦ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: app-builds
        path: |
          ./gabi-family-docs-app/android/app/build/outputs/apk/
          ./gabi-family-docs-app/ios/build/
        retention-days: 30

  # Job de Deploy
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'gabi-family-docs-app/package-lock.json'
        
    - name: ğŸ“¦ Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: app-builds
        path: ./builds
        
    - name: ğŸ”§ Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: ğŸš€ Deploy para VPS
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd /home/gabifamilydoc/GabiFamilyDocs
          git pull origin main
          cd gabi-family-docs-app
          npm ci
          npm run build:production
          pm2 restart gabi-family-docs || pm2 start npm --name "gabi-family-docs" -- start
          echo "Deploy concluÃ­do em $(date)"
        EOF
        
    - name: ğŸ“Š Notificar deploy
      run: |
        curl -X POST ${{ secrets.DEPLOY_WEBHOOK }} \
          -H "Content-Type: application/json" \
          -d '{
            "text": "ğŸš€ Deploy do Gabi Family Docs concluÃ­do!",
            "attachments": [{
              "color": "good",
              "fields": [
                {"title": "Branch", "value": "${{ github.ref_name }}", "short": true},
                {"title": "Commit", "value": "${{ github.sha }}", "short": true},
                {"title": "Autor", "value": "${{ github.actor }}", "short": true},
                {"title": "Timestamp", "value": "${{ github.event.head_commit.timestamp }}", "short": true}
              ]
            }]
          }'

  # Job de Monitoramento
  monitoring:
    name: ğŸ“Š Monitoramento
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ” Verificar saÃºde da aplicaÃ§Ã£o
      run: |
        sleep 30  # Aguarda o deploy
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL }}/health)
        if [ $response -eq 200 ]; then
          echo "âœ… AplicaÃ§Ã£o estÃ¡ saudÃ¡vel"
        else
          echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ respondendo corretamente"
          exit 1
        fi
        
    - name: ğŸ“ˆ Verificar mÃ©tricas
      run: |
        # Verificar mÃ©tricas de performance
        curl -s ${{ secrets.APP_URL }}/metrics | grep -q "app_uptime"
        echo "âœ… MÃ©tricas estÃ£o sendo coletadas"
        
    - name: ğŸ”” Notificar sucesso
      run: |
        curl -X POST ${{ secrets.MONITORING_WEBHOOK }} \
          -H "Content-Type: application/json" \
          -d '{
            "text": "âœ… Deploy e monitoramento concluÃ­dos com sucesso!",
            "attachments": [{
              "color": "good",
              "fields": [
                {"title": "Status", "value": "Online", "short": true},
                {"title": "Tempo de resposta", "value": "< 200ms", "short": true},
                {"title": "Uptime", "value": "100%", "short": true}
              ]
            }]
          }'

  # Job de Rollback (se necessÃ¡rio)
  rollback:
    name: ğŸ”„ Rollback
    runs-on: ubuntu-latest
    needs: [deploy, monitoring]
    if: failure() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ”§ Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: ğŸ”„ Executar rollback
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd /home/gabifamilydoc/GabiFamilyDocs
          git log --oneline -5
          echo "Executando rollback..."
          git reset --hard HEAD~1
          cd gabi-family-docs-app
          npm ci
          pm2 restart gabi-family-docs
          echo "Rollback concluÃ­do"
        EOF
        
    - name: ğŸ”” Notificar rollback
      run: |
        curl -X POST ${{ secrets.ALERT_WEBHOOK }} \
          -H "Content-Type: application/json" \
          -d '{
            "text": "ğŸ”„ Rollback executado automaticamente!",
            "attachments": [{
              "color": "warning",
              "fields": [
                {"title": "Motivo", "value": "Falha no deploy/monitoramento", "short": true},
                {"title": "AÃ§Ã£o", "value": "Rollback para versÃ£o anterior", "short": true},
                {"title": "Status", "value": "AplicaÃ§Ã£o restaurada", "short": true}
              ]
            }]
          }'
